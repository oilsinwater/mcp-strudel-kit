# Test Design: Story 1.2 – MCP Server Core Implementation

Date: 2025-10-15  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- By level:
  - Unit: 7
  - Integration: 11
  - End-to-end: 4
- Priority distribution:
  - P0: 10
  - P1: 10
  - P2: 2
  - P3: 0

Focus is on protocol compliance (R1), execution safety (R2), graceful shutdown (R3), middleware ordering (R4), timeout behavior (R5), configuration consistency (R6), and baseline performance (R7). Tests are ordered to deliver fast feedback on P0 scenarios first.

## Test Scenarios by Acceptance Criteria

### AC1: xmcp Framework Integration

| ID           | Level       | Priority | Test                                                                        | Justification                                                       | Mitigates |
| ------------ | ----------- | -------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------- | --------- |
| 1.2-UNIT-001 | Unit        | P1       | Verify bootstrap derives port from `PORT` env var with 3000 fallback        | Pure config logic, prevents misconfiguration regressions            | R6        |
| 1.2-INT-001  | Integration | P0       | Start server and assert `createMCPServer` wiring with router/middleware     | Validates core server wiring end-to-end without full client journey | R1        |
| 1.2-INT-002  | Integration | P1       | Simulate SIGINT and confirm graceful shutdown waits for in-flight callbacks | Ensures reliability of shutdown behavior                            | R3        |
| 1.2-E2E-001  | E2E         | P0       | Client handshake validates JSON-RPC 2.0 greeting and capabilities           | Confirms protocol compliance from external agent perspective        | R1        |

### AC2: Request/Response Handling

| ID           | Level       | Priority | Test                                                                      | Justification                                             | Mitigates |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------- | --------------------------------------------------------- | --------- |
| 1.2-UNIT-002 | Unit        | P0       | Reject malformed JSON-RPC envelopes in validator utility                  | Critical schema enforcement best handled at unit level    | R1        |
| 1.2-UNIT-003 | Unit        | P0       | Map internal errors to MCP error codes/messages                           | Ensures deterministic error translation                   | R1        |
| 1.2-INT-003  | Integration | P0       | Route valid request to sample tool and return success payload             | Confirms router/registry wiring without full e2e overhead | R1, R2    |
| 1.2-INT-004  | Integration | P1       | Verify correlation IDs propagate through middleware and response          | Observability requirement spanning multiple components    | R4        |
| 1.2-E2E-002  | E2E         | P0       | Execute sample tool through MCP interface validating response body schema | Full path guarantees contract compliance                  | R1, R2    |

### AC3: Tool Execution Framework

| ID           | Level       | Priority | Test                                                                            | Justification                                | Mitigates |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------------- | -------------------------------------------- | --------- |
| 1.2-UNIT-004 | Unit        | P1       | Ensure execution context initializes per request and clears transient state     | Pure logic, prevents state bleed             | R2        |
| 1.2-UNIT-005 | Unit        | P0       | Timeout controller cancels execution after configured duration                  | Critical safeguard for resource usage        | R5        |
| 1.2-INT-005  | Integration | P0       | Invalid tool input is rejected before invocation                                | Verifies Joi schema integration              | R2        |
| 1.2-INT-006  | Integration | P1       | Simulate tool exceeding timeout; ensure cancellation and timeout error returned | Tests combined timeout + middleware behavior | R5        |

### AC4: Middleware Pipeline

| ID           | Level       | Priority | Test                                                                         | Justification                             | Mitigates |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------- | ----------------------------------------- | --------- |
| 1.2-UNIT-006 | Unit        | P1       | Logging middleware attaches correlation ID and redacts sensitive fields      | Isolated logic suited for unit validation | R4        |
| 1.2-INT-007  | Integration | P0       | Assert middleware execution order (validation → logging → execution → error) | Prevents regressions in pipeline ordering | R4        |
| 1.2-INT-008  | Integration | P0       | Error middleware converts thrown exceptions into JSON-RPC error objects      | Critical for client compatibility         | R1        |
| 1.2-INT-009  | Integration | P1       | Trigger rate limiter threshold and validate structured throttle response     | Validates protection layer behavior       | R4        |
| 1.2-E2E-003  | E2E         | P1       | Issue invalid params request and verify JSON-RPC error payload end-to-end    | Confirms full-stack error propagation     | R1, R2    |

### AC5: Configuration Management

| ID           | Level       | Priority | Test                                                                                                 | Justification                                  | Mitigates |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------------------------------------- | ---------------------------------------------- | --------- |
| 1.2-UNIT-007 | Unit        | P1       | Config loader merges defaults with environment overrides                                             | Simple logic, best covered by fast test        | R6        |
| 1.2-INT-010  | Integration | P2       | Switching `NODE_ENV` between dev/prod adjusts logging/validation flags                               | Ensures configuration toggles apply at runtime | R6        |
| 1.2-E2E-004  | E2E         | P2       | Launch server in production profile and verify debug endpoints disabled                              | Final assurance for deployment settings        | R6        |
| 1.2-INT-011  | Integration | P1       | Load test harness issues 50 concurrent requests, verifying latency budget & absence of dropped calls | Baseline for performance stability             | R7        |

## Risk Coverage

- **R1 – MCP Protocol Compliance**: 1.2-INT-001, 1.2-E2E-001, 1.2-UNIT-002, 1.2-UNIT-003, 1.2-INT-003, 1.2-E2E-002, 1.2-INT-008, 1.2-E2E-003
- **R2 – Tool Execution Safety**: 1.2-INT-003, 1.2-E2E-002, 1.2-UNIT-004, 1.2-INT-005, 1.2-E2E-003
- **R3 – Graceful Shutdown**: 1.2-INT-002
- **R4 – Middleware Ordering & Observability**: 1.2-INT-004, 1.2-UNIT-006, 1.2-INT-007, 1.2-INT-009
- **R5 – Timeout Handling**: 1.2-UNIT-005, 1.2-INT-006
- **R6 – Configuration Drift**: 1.2-UNIT-001, 1.2-UNIT-007, 1.2-INT-010, 1.2-E2E-004
- **R7 – Performance Under Load**: 1.2-INT-011

No uncovered risks remain; all identified scenarios have at least one mitigating test.

## Recommended Execution Order

1. P0 Unit tests (`1.2-UNIT-002`, `1.2-UNIT-003`, `1.2-UNIT-005`)
2. P0 Integration tests (`1.2-INT-001`, `1.2-INT-003`, `1.2-INT-005`, `1.2-INT-007`, `1.2-INT-008`)
3. P0 End-to-End tests (`1.2-E2E-001`, `1.2-E2E-002`)
4. Remaining P1 scenarios (units, integrations, E2E)
5. P2 configuration validations

This sequence maximizes early detection of protocol or validation regressions before exercising heavier-weight paths.
